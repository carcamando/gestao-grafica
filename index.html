<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Gráfica Traços Ltda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { border-bottom-color: #1D4ED8; color: #1D4ED8; font-weight: 600; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            z-index: 50;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 90%; max-width: 800px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .edit-view { display: none; }
        /* Adicionando um fundo claro e borda para todos os inputs, selects e textareas */
        input, select, textarea {
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #9ca3af; /* border-gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Autenticação -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div id="login-box" class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-md text-center">
            <h2 class="text-2xl font-bold text-gray-800">Acesso ao Sistema</h2>
            <p class="text-gray-600">Use sua conta do Google para entrar com segurança.</p>
            <button id="google-login-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="mr-2 -ml-1 h-5 w-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M10 2C5.03 2 1 6.03 1 11s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zM8.94 16.54C6.47 16.54 4.5 14.57 4.5 12.1s1.97-4.44 4.44-4.44c1.17 0 2.24.47 3.01 1.24l-1.2 1.2c-.4-.38-1.03-.64-1.81-.64-1.54 0-2.78 1.24-2.78 2.78s1.24 2.78 2.78 2.78c1.78 0 2.45-1.12 2.58-1.74h-2.58v-1.98h4.48c.07.38.12.78.12 1.22 0 2.66-1.78 4.6-4.6 4.6z" /></svg>
                Entrar com Google
            </button>
        </div>
        <div id="access-denied-box" class="hidden w-full max-w-sm p-8 space-y-4 bg-white rounded-lg shadow-md text-center">
             <h2 class="text-2xl font-bold text-red-600">Acesso Negado</h2>
             <p class="text-gray-600">Seu e-mail não está autorizado a acessar este sistema. Por favor, entre em contato com o administrador.</p>
             <button id="logout-denied-btn" class="w-full mt-4 py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">Sair</button>
        </div>
    </div>


    <!-- Container Principal da Aplicação (escondido por padrão) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <!-- Cabeçalho -->
            <header class="text-center mb-8 bg-white p-6 rounded-lg shadow-md">
                 <div class="flex justify-between items-center">
                    <div></div> <!-- Espaçador -->
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Sistema de Gestão Gráfica Traços Ltda</h1>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Sair</button>
                </div>
                <div class="mt-4 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="text-green-600 h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    <p class="text-xl font-semibold text-green-600">(54) 99617-2271</p>
                </div>
            </header>

            <!-- Navegação das Abas -->
            <div class="mb-6 border-b border-gray-300">
                <nav class="flex flex-wrap -mb-px">
                    <button class="tab-button py-4 px-6 border-b-2 border-transparent text-lg text-gray-500 hover:text-blue-600 focus:outline-none active" data-target="orcamentos">Orçamentos</button>
                    <button class="tab-button py-4 px-6 border-b-2 border-transparent text-lg text-gray-500 hover:text-blue-600 focus:outline-none" data-target="clientes">Clientes</button>
                    <button class="tab-button py-4 px-6 border-b-2 border-transparent text-lg text-gray-500 hover:text-blue-600 focus:outline-none" data-target="servicos-cadastrados">Serviços</button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <main>
                <!-- Seção de Orçamentos -->
                <section id="orcamentos" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 id="orcamento-form-title" class="text-2xl font-bold mb-4 text-gray-700">Novo Orçamento</h2>
                        <form id="form-orcamento">
                            <div class="mb-4">
                                <label for="orcamento-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                                <select id="orcamento-cliente" required class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm"></select>
                            </div>
                            <fieldset class="border p-4 rounded-md mb-4">
                                <legend class="text-lg font-medium text-gray-800 px-2">Adicionar Itens</legend>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4" id="form-item-container">
                                    <div class="md:col-span-4"><label for="item-servico" class="block text-sm font-medium">Serviço</label><select id="item-servico" class="mt-1 block w-full rounded-md border border-gray-400"></select></div>
                                    <div class="md:col-span-8"><label for="item-descricao" class="block text-sm font-medium">Descrição</label><input type="text" id="item-descricao" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                                    <div class="md:col-span-4"><label for="item-quantidade" class="block text-sm font-medium">Qtd.</label><input type="number" id="item-quantidade" min="1" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                                    <div class="md:col-span-4"><label for="item-valor-unitario" class="block text-sm font-medium">Valor Unit. (R$)</label><input type="number" step="0.01" id="item-valor-unitario" min="0" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                                    <div class="md:col-span-4 flex items-end"><button type="button" id="add-item-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar</button></div>
                                </div>
                            </fieldset>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Itens do Orçamento</h3>
                            <div id="current-orcamento-items-container" class="border rounded-md min-h-[80px] p-2 mb-4 bg-gray-50"></div>
                            <div class="text-right text-xl font-bold mb-4">Total: <span id="current-orcamento-total">R$ 0,00</span></div>
                            <button id="submit-orcamento-btn" type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Gerar Orçamento Final</button>
                        </form>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4 text-gray-700">Orçamentos Gerados</h3>
                        <div class="mb-4">
                            <label for="search-orcamento-input" class="block text-sm font-medium text-gray-700">Pesquisar por Cliente</label>
                            <input type="text" id="search-orcamento-input" placeholder="Digite o nome do cliente..." class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Itens</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead><tbody id="lista-orcamentos" class="bg-white divide-y"></tbody></table></div>
                    </div>
                </section>

                <!-- Seção de Clientes -->
                <section id="clientes" class="tab-content" style="display: none;">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Novo Cliente</h2>
                        <form id="form-cliente" class="grid grid-cols-1 md:grid-cols-6 gap-4 border-b pb-6 mb-6">
                            <div class="md:col-span-3"><label for="cliente-nome" class="block text-sm font-medium">Nome</label><input type="text" id="cliente-nome" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-3"><label for="cliente-telefone" class="block text-sm font-medium">Telefone/WhatsApp</label><input type="tel" id="cliente-telefone" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="cliente-cpf" class="block text-sm font-medium">CPF</label><input type="text" id="cliente-cpf" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="cliente-cnpj" class="block text-sm font-medium">CNPJ</label><input type="text" id="cliente-cnpj" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="cliente-ie" class="block text-sm font-medium">Inscr. Est.</label><input type="text" id="cliente-ie" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-6"><label for="cliente-email" class="block text-sm font-medium">Email (Opcional)</label><input type="email" id="cliente-email" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-3"><label for="cliente-endereco" class="block text-sm font-medium">Endereço</label><input type="text" id="cliente-endereco" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="cliente-bairro" class="block text-sm font-medium">Bairro</label><input type="text" id="cliente-bairro" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-1"><label for="cliente-numero" class="block text-sm font-medium">Número</label><input type="text" id="cliente-numero" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="cliente-cep" class="block text-sm font-medium">CEP</label><input type="text" id="cliente-cep" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-3"><label for="cliente-cidade" class="block text-sm font-medium">Cidade</label><input type="text" id="cliente-cidade" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-1"><label for="cliente-uf" class="block text-sm font-medium">UF</label><input type="text" id="cliente-uf" maxlength="2" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-6"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Cliente</button></div>
                        </form>
                        <h3 class="text-2xl font-bold mb-4 text-gray-700">Clientes Cadastrados</h3>
                        <div class="mb-4">
                            <label for="search-cliente-input" class="block text-sm font-medium text-gray-700">Pesquisar por Nome</label>
                            <input type="text" id="search-cliente-input" placeholder="Digite o nome do cliente..." class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefone</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CPF/CNPJ</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead><tbody id="lista-clientes" class="bg-white divide-y"></tbody></table></div>
                    </div>
                </section>

                <!-- Seção de Serviços Cadastrados -->
                <section id="servicos-cadastrados" class="tab-content" style="display: none;">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Novo Serviço</h2>
                        <form id="form-servico-cadastro" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-3"><label for="servico-cadastro-nome" class="block text-sm font-medium">Nome do Serviço</label><input type="text" id="servico-cadastro-nome" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div><label for="servico-cadastro-quantidade" class="block text-sm font-medium">Quantidade</label><input type="number" id="servico-cadastro-quantidade" min="1" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div><label for="servico-cadastro-formato" class="block text-sm font-medium">Formato</label><input type="text" id="servico-cadastro-formato" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div><label for="servico-cadastro-cor" class="block text-sm font-medium">Cor Impressão</label><input type="text" id="servico-cadastro-cor" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="servico-cadastro-papel" class="block text-sm font-medium">Tipo de Papel</label><input type="text" id="servico-cadastro-papel" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-2"><label for="servico-cadastro-acabamento" class="block text-sm font-medium">Acabamento</label><input type="text" id="servico-cadastro-acabamento" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-1"><label for="servico-cadastro-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="number" step="0.01" id="servico-cadastro-valor" min="0" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                            <div class="md:col-span-3"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Serviço</button></div>
                        </form>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-700">Serviços Cadastrados</h3>
                            <button id="gerar-relatorio-servicos-cadastrados-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 text-sm">Relatório de Serviços</button>
                        </div>
                         <div class="mb-4">
                            <label for="search-servico-input" class="block text-sm font-medium text-gray-700">Pesquisar por Nome</label>
                            <input type="text" id="search-servico-input" placeholder="Digite o nome do serviço..." class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Formato</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Papel</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead><tbody id="lista-servicos-cadastrados" class="bg-white divide-y"></tbody></table></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal de Edição de Cliente -->
    <div id="edit-cliente-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-gray-700">Editar Cliente</h2>
                 <button id="close-edit-cliente-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <form id="form-edit-cliente" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div class="md:col-span-3"><label for="edit-cliente-nome" class="block text-sm font-medium">Nome</label><input type="text" id="edit-cliente-nome" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-3"><label for="edit-cliente-telefone" class="block text-sm font-medium">Telefone/WhatsApp</label><input type="tel" id="edit-cliente-telefone" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-cliente-cpf" class="block text-sm font-medium">CPF</label><input type="text" id="edit-cliente-cpf" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-cliente-cnpj" class="block text-sm font-medium">CNPJ</label><input type="text" id="edit-cliente-cnpj" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-cliente-ie" class="block text-sm font-medium">Inscr. Est.</label><input type="text" id="edit-cliente-ie" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-6"><label for="edit-cliente-email" class="block text-sm font-medium">Email</label><input type="email" id="edit-cliente-email" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-3"><label for="edit-cliente-endereco" class="block text-sm font-medium">Endereço</label><input type="text" id="edit-cliente-endereco" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-cliente-bairro" class="block text-sm font-medium">Bairro</label><input type="text" id="edit-cliente-bairro" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-1"><label for="edit-cliente-numero" class="block text-sm font-medium">Número</label><input type="text" id="edit-cliente-numero" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-cliente-cep" class="block text-sm font-medium">CEP</label><input type="text" id="edit-cliente-cep" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-3"><label for="edit-cliente-cidade" class="block text-sm font-medium">Cidade</label><input type="text" id="edit-cliente-cidade" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-1"><label for="edit-cliente-uf" class="block text-sm font-medium">UF</label><input type="text" id="edit-cliente-uf" maxlength="2" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-6"><button type="submit" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Salvar Alterações</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Edição de Serviço Cadastrado -->
    <div id="edit-servico-cadastro-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-gray-700">Editar Serviço</h2>
                 <button id="close-edit-servico-cadastro-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <form id="form-edit-servico-cadastro" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2"><label for="edit-servico-cadastro-nome" class="block text-sm font-medium">Nome do Serviço</label><input type="text" id="edit-servico-cadastro-nome" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cadastro-quantidade" class="block text-sm font-medium">Quantidade</label><input type="number" id="edit-servico-cadastro-quantidade" min="1" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cadastro-formato" class="block text-sm font-medium">Formato</label><input type="text" id="edit-servico-cadastro-formato" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cadastro-cor" class="block text-sm font-medium">Cor Impressão</label><input type="text" id="edit-servico-cadastro-cor" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cadastro-papel" class="block text-sm font-medium">Tipo de Papel</label><input type="text" id="edit-servico-cadastro-papel" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-servico-cadastro-acabamento" class="block text-sm font-medium">Acabamento</label><input type="text" id="edit-servico-cadastro-acabamento" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><label for="edit-servico-cadastro-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="number" step="0.01" id="edit-servico-cadastro-valor" min="0" class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-2"><button type="submit" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Salvar Alterações</button></div>
            </form>
        </div>
    </div>


    <!-- Modal para Gerenciar Serviços do Cliente -->
    <div id="servicos-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <div class="flex items-center">
                     <button id="gerar-relatorio-servicos-btn" class="bg-purple-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-purple-700 text-sm" style="display: none;">Gerar Relatório</button>
                     <button id="close-modal-button" class="text-3xl font-bold ml-4">&times;</button>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="text-xl font-bold mb-3">Adicionar Novo Serviço</h3>
                <form id="form-servico" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3"><label for="servico-descricao-input" class="block text-sm font-medium">Serviço/Descrição</label><input type="text" id="servico-descricao-input" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                    <div><label for="servico-data" class="block text-sm font-medium">Data</label><input type="date" id="servico-data" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                    <div><label for="servico-quantidade" class="block text-sm font-medium">Quantidade</label><input type="number" min="1" id="servico-quantidade" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                    <div><label for="servico-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="number" step="0.01" min="0" id="servico-valor" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                    <div class="md:col-span-3"><label for="servico-anexo" class="block text-sm font-medium">Anexar Arquivo</label><input type="file" id="servico-anexo" class="mt-1 block w-full text-sm"></div>
                    <div class="md:col-span-3"><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar Serviço</button></div>
                </form>
            </div>
            <h3 class="text-xl font-bold mb-3">Serviços Cadastrados</h3>
            <div id="lista-servicos-container" class="overflow-x-auto"></div>
        </div>
    </div>
    
     <!-- Modal de Edição de Serviço do Cliente -->
    <div id="edit-servico-cliente-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-gray-700">Editar Serviço</h2>
                 <button id="close-edit-servico-cliente-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <form id="form-edit-servico-cliente" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-3"><label for="edit-servico-cliente-descricao-input" class="block text-sm font-medium">Serviço/Descrição</label><input type="text" id="edit-servico-cliente-descricao-input" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cliente-data" class="block text-sm font-medium">Data</label><input type="date" id="edit-servico-cliente-data" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cliente-quantidade" class="block text-sm font-medium">Quantidade</label><input type="number" min="1" id="edit-servico-cliente-quantidade" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div><label for="edit-servico-cliente-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="number" step="0.01" min="0" id="edit-servico-cliente-valor" required class="mt-1 block w-full rounded-md border border-gray-400"></div>
                <div class="md:col-span-3"><button type="submit" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Salvar Alterações</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyBlcb66W1kyFts9yvwim3bLHq6ctstQOak",
            authDomain: "sistema-gestao-grafica.firebaseapp.com",
            projectId: "sistema-gestao-grafica",
            storageBucket: "sistema-gestao-grafica.firebasestorage.app",
            messagingSenderId: "896118171238",
            appId: "1:896118171238:web:90eb4dea6dfc7cb195efa7"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const accessDeniedBox = document.getElementById('access-denied-box');
        const loginBox = document.getElementById('login-box');
        const logoutDeniedBtn = document.getElementById('logout-denied-btn');

        const provider = new GoogleAuthProvider();

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Erro no login com Google: ", error);
                    alert("Falha ao fazer login com o Google. Verifique o console para mais detalhes.");
                });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        logoutDeniedBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "usuarios_autorizados", user.email);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userId = user.uid;
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    runApp();
                } else {
                    loginBox.classList.add('hidden');
                    accessDeniedBox.classList.remove('hidden');
                    authContainer.style.display = 'flex';
                    appContainer.style.display = 'none';
                }
            } else {
                loginBox.classList.remove('hidden');
                accessDeniedBox.classList.add('hidden');
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        function runApp() {
            let clientes = [], servicosCadastrados = [], orcamentos = [], currentItems = [];
            let orcamentoCounter = 1, servicoCounter = 1, activeClientId = null, editingBudgetId = null, editingClientId = null, editingServicoCadastradoId = null, editingServicoClienteId = null;
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const formCliente = document.getElementById('form-cliente');
            const listaClientes = document.getElementById('lista-clientes');
            const searchClienteInput = document.getElementById('search-cliente-input');
            const formServicoCadastro = document.getElementById('form-servico-cadastro');
            const listaServicosCadastrados = document.getElementById('lista-servicos-cadastrados');
            const searchServicoInput = document.getElementById('search-servico-input');
            const formOrcamento = document.getElementById('form-orcamento');
            const listaOrcamentos = document.getElementById('lista-orcamentos');
            const searchOrcamentoInput = document.getElementById('search-orcamento-input');
            const selectOrcamentoCliente = document.getElementById('orcamento-cliente');
            const selectItemServico = document.getElementById('item-servico');
            const addItemBtn = document.getElementById('add-item-btn');
            const currentItemsContainer = document.getElementById('current-orcamento-items-container');
            const currentTotalSpan = document.getElementById('current-orcamento-total');
            const servicosModal = document.getElementById('servicos-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalButton = document.getElementById('close-modal-button');
            const formServico = document.getElementById('form-servico');
            const listaServicosContainer = document.getElementById('lista-servicos-container');
            const orcamentoFormTitle = document.getElementById('orcamento-form-title');
            const submitOrcamentoBtn = document.getElementById('submit-orcamento-btn');
            const editClienteModal = document.getElementById('edit-cliente-modal');
            const formEditCliente = document.getElementById('form-edit-cliente');
            const closeEditClienteModalBtn = document.getElementById('close-edit-cliente-modal-btn');
            const editServicoCadastroModal = document.getElementById('edit-servico-cadastro-modal');
            const formEditServicoCadastro = document.getElementById('form-edit-servico-cadastro');
            const closeEditServicoCadastroModalBtn = document.getElementById('close-edit-servico-cadastro-modal-btn');
            const editServicoClienteModal = document.getElementById('edit-servico-cliente-modal');
            const formEditServicoCliente = document.getElementById('form-edit-servico-cliente');
            const closeEditServicoClienteModalBtn = document.getElementById('close-edit-servico-cliente-modal-btn');
            const gerarRelatorioProdutosBtn = document.getElementById('gerar-relatorio-produtos-btn');
            
            const docRef = doc(db, "data", userId);

            const salvarDados = async () => {
                const dataToSave = { clientes, produtos: servicosCadastrados, orcamentos, orcamentoCounter, servicoCounter };
                try {
                    await setDoc(docRef, dataToSave);
                } catch (e) { console.error("Erro ao salvar dados: ", e); }
            };

            const carregarDados = async () => {
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        clientes = data.clientes || [];
                        servicosCadastrados = data.produtos || []; 
                        orcamentos = data.orcamentos || [];
                        orcamentoCounter = data.orcamentoCounter || 1;
                        servicoCounter = data.servicoCounter || 1;
                    }
                } catch (e) { console.error("Erro ao carregar dados: ", e); }
                renderizarTudo();
            };

            const formatCurrency = (value, decimals = 2) => {
                if (isNaN(value) || value === null) return "R$ 0,00";
                return `R$ ${parseFloat(value).toFixed(decimals).replace('.', ',')}`;
            }

            const renderizarTudo = () => { renderizarClientes(); renderizarServicosCadastrados(); renderizarOrcamentos(); };
            const atualizarSelects = () => {
                selectOrcamentoCliente.innerHTML = '<option value="" disabled selected>Selecione...</option>';
                const clientesOrdenados = [...clientes].sort((a, b) => a.nome.localeCompare(b.nome));
                clientesOrdenados.forEach((c) => selectOrcamentoCliente.add(new Option(c.nome, c.id)));
                
                selectItemServico.innerHTML = '<option value="" disabled selected>Selecione...</option>';
                const servicosOrdenados = [...servicosCadastrados].sort((a, b) => a.nome.localeCompare(b.nome));
                servicosOrdenados.forEach((p) => selectItemServico.add(new Option(p.nome, p.id)));
            };

            const renderizarClientes = () => {
                const searchTerm = searchClienteInput.value.toLowerCase();
                let filteredClientes = clientes.filter(c => c.nome.toLowerCase().includes(searchTerm));
                filteredClientes.sort((a, b) => a.nome.localeCompare(b.nome));
                listaClientes.innerHTML = filteredClientes.length === 0 ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum cliente</td></tr>' : filteredClientes.map(c => `<tr id="cliente-${c.id}" class="hover:bg-gray-50"><td class="px-6 py-4">${c.nome}</td><td class="px-6 py-4">${c.telefone}</td><td class="px-6 py-4">${c.cpf || c.cnpj || 'N/A'}</td><td class="px-6 py-4 text-sm font-medium"><div class="flex items-center space-x-2 flex-wrap"><button data-id="${c.id}" class="manage-services-btn text-green-600 hover:text-green-900">Serviços</button><button data-id="${c.id}" class="edit-btn text-blue-600 hover:text-blue-900">Editar</button><button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-900">Deletar</button><button data-id="${c.id}" class="report-cliente-btn text-purple-600 hover:text-purple-900">Relatório</button></div></td></tr>`).join('');
                atualizarSelects();
            };

            const renderizarServicosCadastrados = () => {
                const searchTerm = searchServicoInput.value.toLowerCase();
                let filteredServicos = servicosCadastrados.filter(p => p.nome.toLowerCase().includes(searchTerm));
                filteredServicos.sort((a, b) => a.nome.localeCompare(b.nome));
                listaServicosCadastrados.innerHTML = filteredServicos.length === 0 ? '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum serviço</td></tr>' : filteredServicos.map(p => `<tr id="servico-cadastrado-${p.id}" class="hover:bg-gray-50"><td class="px-6 py-4">${p.nome}</td><td class="px-6 py-4">${p.formato||'N/A'}</td><td class="px-6 py-4">${p.papel||'N/A'}</td><td class="px-6 py-4">${formatCurrency(p.valor)}</td><td class="px-6 py-4"><div class="flex items-center space-x-2"><button data-id="${p.id}" class="edit-servico-cadastro-btn text-blue-600 hover:text-blue-900">Editar</button><button data-id="${p.id}" class="delete-servico-cadastro-btn text-red-600 hover:text-red-900">Excluir</button></div></td></tr>`).join('');
                atualizarSelects();
            };
            
            const renderizarOrcamentos = () => {
                const searchTerm = searchOrcamentoInput.value.toLowerCase();
                let filteredOrcamentos = orcamentos.filter(orc => orc.cliente.nome.toLowerCase().includes(searchTerm));
                filteredOrcamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
                listaOrcamentos.innerHTML = filteredOrcamentos.length === 0 ? '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum orçamento</td></tr>' : filteredOrcamentos.map(orc => `<tr class="hover:bg-gray-50"><td class="px-6 py-4">${orc.cliente.nome}</td><td class="px-6 py-4">${orc.items.map(i=>i.nome).join(', ')}</td><td class="px-6 py-4">${formatCurrency(orc.total)}</td><td class="px-6 py-4">${orc.data}</td><td class="px-6 py-4"><div class="flex space-x-2"><button data-id="${orc.id}" class="edit-orcamento-btn text-blue-600 hover:text-blue-900">Editar</button><button data-id="${orc.id}" class="delete-orcamento-btn text-red-600 hover:text-red-900">Excluir</button><button data-id="${orc.id}" class="pdf-orcamento-btn text-purple-600 hover:text-purple-900">PDF</button></div></td></tr>`).join('');
            };
            
            const renderizarCurrentItems = () => {
                currentItemsContainer.innerHTML = currentItems.length === 0 ? '<p class="text-center text-gray-500">Nenhum item adicionado.</p>' : `<table class="min-w-full text-sm"><tbody>${currentItems.map((item,index)=>`<tr><td class="p-1">${item.nome}</td><td class="p-1">${item.quantidade} un.</td><td class="p-1 text-right">${formatCurrency(item.valorTotal)}</td><td class="p-1 text-right"><button type="button" data-index="${index}" class="remove-item-btn text-red-500 font-bold">&times;</button></td></tr>`).join('')}</tbody></table>`;
                currentTotalSpan.textContent = formatCurrency(currentItems.reduce((acc, item) => acc + item.valorTotal, 0));
            };
            
            tabButtons.forEach(button => button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); tabContents.forEach(content => content.style.display = 'none'); document.getElementById(button.dataset.target).style.display = 'block'; }));

            formCliente.addEventListener('submit', e => { e.preventDefault(); clientes.push({ id: Date.now(), nome: e.target.elements['cliente-nome'].value, telefone: e.target.elements['cliente-telefone'].value, email: e.target.elements['cliente-email'].value, cpf: e.target.elements['cliente-cpf'].value, cnpj: e.target.elements['cliente-cnpj'].value, ie: e.target.elements['cliente-ie'].value, endereco: e.target.elements['cliente-endereco'].value, bairro: e.target.elements['cliente-bairro'].value, numero: e.target.elements['cliente-numero'].value, cep: e.target.elements['cliente-cep'].value, cidade: e.target.elements['cliente-cidade'].value, uf: e.target.elements['cliente-uf'].value, servicos: [] }); salvarDados(); renderizarClientes(); formCliente.reset(); });
            formServicoCadastro.addEventListener('submit', e => { e.preventDefault(); servicosCadastrados.push({ id: Date.now(), nome: e.target.elements['servico-cadastro-nome'].value, quantidade: parseInt(e.target.elements['servico-cadastro-quantidade'].value, 10) || 1, valor: parseFloat(e.target.elements['servico-cadastro-valor'].value) || 0, formato: e.target.elements['servico-cadastro-formato'].value, cor: e.target.elements['servico-cadastro-cor'].value, papel: e.target.elements['servico-cadastro-papel'].value, acabamento: e.target.elements['servico-cadastro-acabamento'].value }); salvarDados(); renderizarServicosCadastrados(); formServicoCadastro.reset(); });

            searchClienteInput.addEventListener('keyup', renderizarClientes);
            searchServicoInput.addEventListener('keyup', renderizarServicosCadastrados);
            searchOrcamentoInput.addEventListener('keyup', renderizarOrcamentos);

            listaClientes.addEventListener('click', e => {
                const btn = e.target.closest('button'); if (!btn) return;
                const id = parseInt(btn.dataset.id); 
                if (btn.classList.contains('edit-btn')) { 
                    editingClientId = id;
                    const cliente = clientes.find(c => c.id === id);
                    formEditCliente.elements['edit-cliente-nome'].value = cliente.nome || '';
                    formEditCliente.elements['edit-cliente-telefone'].value = cliente.telefone || '';
                    formEditCliente.elements['edit-cliente-cpf'].value = cliente.cpf || '';
                    formEditCliente.elements['edit-cliente-cnpj'].value = cliente.cnpj || '';
                    formEditCliente.elements['edit-cliente-ie'].value = cliente.ie || '';
                    formEditCliente.elements['edit-cliente-email'].value = cliente.email || '';
                    formEditCliente.elements['edit-cliente-endereco'].value = cliente.endereco || '';
                    formEditCliente.elements['edit-cliente-bairro'].value = cliente.bairro || '';
                    formEditCliente.elements['edit-cliente-numero'].value = cliente.numero || '';
                    formEditCliente.elements['edit-cliente-cep'].value = cliente.cep || '';
                    formEditCliente.elements['edit-cliente-cidade'].value = cliente.cidade || '';
                    formEditCliente.elements['edit-cliente-uf'].value = cliente.uf || '';
                    editClienteModal.classList.add('visible');
                } else if (btn.classList.contains('delete-btn')) { 
                    clientes = clientes.filter(c => c.id !== id); 
                    orcamentos = orcamentos.filter(o => !o.cliente || o.cliente.id !== id); 
                    salvarDados(); 
                    renderizarClientes(); 
                    renderizarOrcamentos(); 
                } else if (btn.classList.contains('manage-services-btn')) { activeClientId = id; const cliente = clientes.find(c => c.id === id); modalTitle.textContent = `Serviços de ${cliente.nome}`; renderizarServicos(id); servicosModal.classList.add('visible'); 
                } else if (btn.classList.contains('report-cliente-btn')) { const cliente = clientes.find(c => c.id === id); if (cliente && cliente.servicos && cliente.servicos.length > 0) { gerarPDFRelatorioServicos(cliente); } else { alert('Este cliente não possui serviços para gerar um relatório.'); } }
            });
            
            closeEditClienteModalBtn.addEventListener('click', () => editClienteModal.classList.remove('visible'));
            formEditCliente.addEventListener('submit', (e) => {
                e.preventDefault();
                const cliente = clientes.find(c => c.id === editingClientId);
                if(cliente) {
                    cliente.nome = formEditCliente.elements['edit-cliente-nome'].value;
                    cliente.telefone = formEditCliente.elements['edit-cliente-telefone'].value;
                    cliente.cpf = formEditCliente.elements['edit-cliente-cpf'].value;
                    cliente.cnpj = formEditCliente.elements['edit-cliente-cnpj'].value;
                    cliente.ie = formEditCliente.elements['edit-cliente-ie'].value;
                    cliente.email = formEditCliente.elements['edit-cliente-email'].value;
                    cliente.endereco = formEditCliente.elements['edit-cliente-endereco'].value;
                    cliente.bairro = formEditCliente.elements['edit-cliente-bairro'].value;
                    cliente.numero = formEditCliente.elements['edit-cliente-numero'].value;
                    cliente.cep = formEditCliente.elements['edit-cliente-cep'].value;
                    cliente.cidade = formEditCliente.elements['edit-cliente-cidade'].value;
                    cliente.uf = formEditCliente.elements['edit-cliente-uf'].value;
                    salvarDados();
                    renderizarClientes();
                    editClienteModal.classList.remove('visible');
                }
            });

            selectItemServico.addEventListener('change', e => {
                if (e.target.value === "") return;
                const p = servicosCadastrados.find(p => p.id === parseInt(e.target.value));
                if (p) {
                    const descricaoDetalhada = `Formato: ${p.formato || ''}, Cor: ${p.cor || ''}, Papel: ${p.papel || ''}, Acabamento: ${p.acabamento || ''}`;
                    document.getElementById('item-descricao').value = descricaoDetalhada.replace(/,(\s*,)+/g, ',').replace(/^,|,$/g, '').trim();
                    document.getElementById('item-quantidade').value = p.quantidade || 1;
                    const valorUnitario = (p.valor && p.quantidade > 0) ? (p.valor / p.quantidade) : 0;
                    document.getElementById('item-valor-unitario').value = valorUnitario.toFixed(4);
                }
            });

            addItemBtn.addEventListener('click', () => {
                const pIndex = selectItemServico.value; if (pIndex === "") { alert('Selecione um serviço.'); return; }
                const servicoCadastrado = servicosCadastrados.find(p => p.id === parseInt(pIndex)); const quantidade = parseInt(document.getElementById('item-quantidade').value, 10); const valorUnitario = parseFloat(document.getElementById('item-valor-unitario').value);
                if (!quantidade || isNaN(valorUnitario)) { alert('Preencha a quantidade e o valor corretamente.'); return; }
                currentItems.push({ nome: servicoCadastrado.nome, descricao: document.getElementById('item-descricao').value, quantidade: quantidade, valorUnitario: valorUnitario, valorTotal: quantidade * valorUnitario });
                renderizarCurrentItems();
                document.getElementById('form-item-container').querySelectorAll('input, select').forEach(el => { if (el.tagName === 'SELECT') { el.selectedIndex = 0; } else { el.value = ''; } });
            });
            
            currentItemsContainer.addEventListener('click', e => { const btn = e.target.closest('.remove-item-btn'); if(btn) { currentItems.splice(btn.dataset.index, 1); renderizarCurrentItems(); } });

            formOrcamento.addEventListener('submit', e => {
                e.preventDefault(); const clienteId = selectOrcamentoCliente.value; if (clienteId === "" || currentItems.length === 0) { alert("Selecione um cliente e adicione itens."); return; }
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                if (editingBudgetId) {
                    const orcamentoIndex = orcamentos.findIndex(o => o.id === editingBudgetId);
                    orcamentos[orcamentoIndex] = { ...orcamentos[orcamentoIndex], cliente: cliente, items: [...currentItems], total: currentItems.reduce((acc, item) => acc + item.valorTotal, 0) };
                    editingBudgetId = null;
                    orcamentoFormTitle.textContent = "Novo Orçamento";
                    submitOrcamentoBtn.textContent = "Gerar Orçamento Final";
                    submitOrcamentoBtn.classList.replace('bg-yellow-500', 'bg-blue-600');
                } else {
                    orcamentos.push({ id: orcamentoCounter++, cliente: cliente, items: [...currentItems], total: currentItems.reduce((acc, item) => acc + item.valorTotal, 0), data: new Date().toLocaleDateString('pt-BR') });
                }
                currentItems = []; renderizarOrcamentos(); renderizarCurrentItems(); salvarDados(); formOrcamento.reset(); atualizarSelects();
            });

            listaOrcamentos.addEventListener('click', e => {
                const btn = e.target.closest('button'); if (!btn) return;
                const id = parseInt(btn.dataset.id);
                if(btn.classList.contains('pdf-orcamento-btn')) { const orcamento = orcamentos.find(o => o.id === id); if (orcamento) gerarPDFOrcamento(orcamento); }
                else if (btn.classList.contains('delete-orcamento-btn')) { orcamentos = orcamentos.filter(o => o.id !== id); salvarDados(); renderizarOrcamentos();  }
                else if(btn.classList.contains('edit-orcamento-btn')) {
                    const orcamento = orcamentos.find(o => o.id === id);
                    if(orcamento) {
                        editingBudgetId = orcamento.id;
                        selectOrcamentoCliente.value = orcamento.cliente.id;
                        currentItems = [...orcamento.items];
                        renderizarCurrentItems();
                        orcamentoFormTitle.textContent = `Editando Orçamento Nº ${String(id).padStart(4,'0')}`;
                        submitOrcamentoBtn.textContent = "Salvar Alterações";
                        submitOrcamentoBtn.classList.replace('bg-blue-600', 'bg-yellow-500');
                        window.scrollTo(0, 0);
                    }
                }
            });

            listaServicosCadastrados.addEventListener('click', e => {
                const btn = e.target.closest('button'); if (!btn) return;
                const id = parseInt(btn.dataset.id);
                if (btn.classList.contains('edit-servico-cadastro-btn')) { 
                    editingServicoCadastradoId = id;
                    const servico = servicosCadastrados.find(p => p.id === id);
                    formEditServicoCadastro.elements['edit-servico-cadastro-nome'].value = servico.nome || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-quantidade'].value = servico.quantidade || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-valor'].value = servico.valor || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-formato'].value = servico.formato || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-cor'].value = servico.cor || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-papel'].value = servico.papel || '';
                    formEditServicoCadastro.elements['edit-servico-cadastro-acabamento'].value = servico.acabamento || '';
                    editServicoCadastroModal.classList.add('visible');
                } else if (btn.classList.contains('delete-servico-cadastro-btn')) { servicosCadastrados = servicosCadastrados.filter(p => p.id !== id); salvarDados(); renderizarServicosCadastrados(); }
            });
            
            closeEditServicoCadastroModalBtn.addEventListener('click', () => editServicoCadastroModal.classList.remove('visible'));
            formEditServicoCadastro.addEventListener('submit', (e) => {
                e.preventDefault();
                const servico = servicosCadastrados.find(p => p.id === editingServicoCadastradoId);
                if(servico) {
                    servico.nome = formEditServicoCadastro.elements['edit-servico-cadastro-nome'].value;
                    servico.quantidade = parseInt(formEditServicoCadastro.elements['edit-servico-cadastro-quantidade'].value, 10);
                    servico.valor = parseFloat(formEditServicoCadastro.elements['edit-servico-cadastro-valor'].value);
                    servico.formato = formEditServicoCadastro.elements['edit-servico-cadastro-formato'].value;
                    servico.cor = formEditServicoCadastro.elements['edit-servico-cadastro-cor'].value;
                    servico.papel = formEditServicoCadastro.elements['edit-servico-cadastro-papel'].value;
                    servico.acabamento = formEditServicoCadastro.elements['edit-servico-cadastro-acabamento'].value;
                    salvarDados();
                    renderizarServicosCadastrados();
                    editServicoCadastroModal.classList.remove('visible');
                }
            });
            
            closeModalButton.addEventListener('click', () => servicosModal.classList.remove('visible'));
            
            const renderizarServicos = (clienteId) => {
                const cliente = clientes.find(c => c.id === clienteId);
                const relatorioBtn = servicosModal.querySelector('#gerar-relatorio-servicos-btn');
                const servicosOrdenados = cliente.servicos ? [...cliente.servicos].sort((a, b) => new Date(b.data) - new Date(a.data)) : [];

                if (servicosOrdenados.length === 0) {
                    relatorioBtn.style.display = 'none';
                    listaServicosContainer.innerHTML = '<p class="text-center py-4 text-gray-500">Nenhum serviço cadastrado.</p>';
                } else {
                    relatorioBtn.style.display = 'inline-block';
                    listaServicosContainer.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs font-medium uppercase">Serviço</th><th class="p-2 text-left text-xs font-medium uppercase">Data</th><th class="p-2 text-left text-xs font-medium uppercase">Qtd.</th><th class="p-2 text-left text-xs font-medium uppercase">Valor</th><th class="p-2 text-left text-xs font-medium uppercase">Anexo</th><th class="p-2 text-left text-xs font-medium uppercase">Ações</th></tr></thead><tbody>${servicosOrdenados.map(s=>`<tr id="servico-${s.id}"><td class="p-2">${s.descricao}</td><td class="p-2">${new Date(s.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td class="p-2">${s.quantidade}</td><td class="p-2">${formatCurrency(s.valor)}</td><td class="p-2">${s.anexo?`<a href="${s.anexo.dados}" download="${s.anexo.nome}" class="text-blue-600">Baixar</a>`:'N/A'}</td><td class="p-2"><div class="flex items-center space-x-2"><button data-servico-id="${s.id}" class="edit-servico-cliente-btn text-blue-600">Editar</button><button data-servico-id="${s.id}" class="delete-servico-btn text-red-600">Excluir</button></div></td></tr>`).join('')}</tbody></table>`;
                }
            };
            
            formServico.addEventListener('submit', async e => {
                e.preventDefault(); if (!activeClientId) return;
                const cliente = clientes.find(c => c.id === activeClientId); const fileInput = document.getElementById('servico-anexo'); let anexo = null;
                if (fileInput.files.length > 0) { const file = fileInput.files[0]; anexo = { nome: file.name, dados: await new Promise(resolve => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.readAsDataURL(file); }) }; }
                cliente.servicos.push({ id: servicoCounter++, descricao: document.getElementById('servico-descricao-input').value, data: document.getElementById('servico-data').value, quantidade: parseInt(document.getElementById('servico-quantidade').value, 10) || 1, valor: parseFloat(document.getElementById('servico-valor').value), anexo: anexo });
                salvarDados(); renderizarServicos(activeClientId); formServico.reset();
            });

            servicosModal.addEventListener('click', e => {
                const btn = e.target.closest('button'); if(!btn) return;
                if (btn.id === 'gerar-relatorio-servicos-btn') { const cliente = clientes.find(c => c.id === activeClientId); if (cliente) gerarPDFRelatorioServicos(cliente); return; }
                const servicoId = parseInt(btn.dataset.servicoId); if (!servicoId) return;
                const cliente = clientes.find(c => c.id === activeClientId);
                if (btn.classList.contains('edit-servico-cliente-btn')) { 
                    editingServicoClienteId = servicoId;
                    const servico = cliente.servicos.find(s => s.id === servicoId);
                    formEditServicoCliente.elements['edit-servico-cliente-descricao-input'].value = servico.descricao || '';
                    formEditServicoCliente.elements['edit-servico-cliente-data'].value = servico.data || '';
                    formEditServicoCliente.elements['edit-servico-cliente-quantidade'].value = servico.quantidade || '';
                    formEditServicoCliente.elements['edit-servico-cliente-valor'].value = servico.valor || '';
                    editServicoClienteModal.classList.add('visible');
                } else if (btn.classList.contains('delete-servico-btn')) { cliente.servicos = cliente.servicos.filter(s => s.id !== servicoId); salvarDados(); renderizarServicos(activeClientId);  }
            });
            
            closeEditServicoClienteModalBtn.addEventListener('click', () => editServicoClienteModal.classList.remove('visible'));
            formEditServicoCliente.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const cliente = clientes.find(c => c.id === activeClientId);
                 const servico = cliente.servicos.find(s => s.id === editingServicoClienteId);
                 if (servico) {
                    servico.descricao = formEditServicoCliente.elements['edit-servico-cliente-descricao-input'].value;
                    servico.data = formEditServicoCliente.elements['edit-servico-cliente-data'].value;
                    servico.quantidade = parseInt(formEditServicoCliente.elements['edit-servico-cliente-quantidade'].value, 10);
                    servico.valor = parseFloat(formEditServicoCliente.elements['edit-servico-cliente-valor'].value);
                    salvarDados();
                    renderizarServicos(activeClientId);
                    editServicoClienteModal.classList.remove('visible');
                 }
            });

            const gerarPDFOrcamento = (orcamento) => {
                const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cliente = orcamento.cliente; let startY = 40;
                doc.setFontSize(18).text("Orçamento - Gráfica Traços Ltda", 14, 22); doc.setFontSize(11).text("Contato: (54) 99617-2271", 14, 30); doc.line(14, 32, 196, 32); doc.setFontSize(12); doc.text(`Data: ${orcamento.data}`, 196, startY, { align: 'right' }); startY += 10; doc.text(`Cliente: ${cliente.nome}`, 14, startY);
                if (cliente.cpf || cliente.cnpj) { startY += 7; doc.text(`CPF/CNPJ: ${cliente.cpf || cliente.cnpj}`, 14, startY); }
                if (cliente.endereco) { startY += 7; doc.text(`Endereço: ${[cliente.endereco, cliente.bairro, cliente.cidade, cliente.uf.toUpperCase()].filter(Boolean).join(', ')}`, 14, startY); }
                doc.autoTable({ head: [["Serviço", "Descrição", "Qtd.", "Vlr. Unit.", "Vlr. Total"]], body: orcamento.items.map(i => [i.nome, i.descricao, i.quantidade, formatCurrency(i.valorUnitario), formatCurrency(i.valorTotal)]), startY: startY + 5, theme: 'striped', headStyles: { fillColor: [30, 64, 175] }, columnStyles: { 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right' } } });
                let finalY = doc.lastAutoTable.finalY; doc.setFontSize(14).setFont(undefined, 'bold').text('Total:', 148, finalY + 12, {align: 'right'}); doc.text(formatCurrency(orcamento.total), 196, finalY + 12, {align: 'right'}); doc.setFontSize(10).setFont(undefined, 'normal').text("Orçamento válido por 30 dias.", 14, finalY + 25); doc.save(`Orcamento-${cliente.nome}-${orcamento.data}.pdf`);
            };
            
            const gerarPDFRelatorioServicos = (cliente) => {
                const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18).text(`Relatório de Serviços - ${cliente.nome}`, 14, 22); doc.setFontSize(11).text("Gráfica Traços Ltda", 14, 30); doc.line(14, 32, 196, 32); doc.setFontSize(12).text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, 196, 40, { align: 'right' });
                const servicosOrdenados = [...cliente.servicos].sort((a, b) => new Date(b.data) - new Date(a.data));
                const tableColumn = ["Data", "Descrição", "Qtd.", "Vlr. Unit.", "Valor Total"]; 
                const tableRows = servicosOrdenados.map(s => {
                    const valorUnitario = (s.valor && s.quantidade > 0) ? (s.valor / s.quantidade) : 0;
                    return [new Date(s.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'}), s.descricao, s.quantidade, formatCurrency(valorUnitario, 4), formatCurrency(s.valor)];
                });
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 45, theme: 'grid', headStyles: { fillColor: [30, 64, 175] }, columnStyles: { 0: { halign: 'center', cellWidth: 25 }, 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right' } } });
                doc.save(`Relatorio-Servicos-${cliente.nome}.pdf`);
            };
             const gerarPDFRelatorioProdutos = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.setFontSize(18).text("Relatório de Serviços Cadastrados", 14, 22);
                doc.setFontSize(11).text("Gráfica Traços Ltda", 14, 30);
                doc.line(14, 32, 282, 32);
                doc.setFontSize(12).text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, 282, 40, { align: 'right' });
                
                const produtosOrdenados = [...servicosCadastrados].sort((a, b) => a.nome.localeCompare(b.nome));
                
                const tableColumn = ["Nome do Serviço", "Qtd.", "Formato", "Cor", "Papel", "Acabamento", "Valor Total"];
                const tableRows = produtosOrdenados.map(p => [
                    p.nome || 'N/A',
                    p.quantidade || 'N/A',
                    p.formato || 'N/A',
                    p.cor || 'N/A',
                    p.papel || 'N/A',
                    p.acabamento || 'N/A',
                    formatCurrency(p.valor)
                ]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 45,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 64, 175] }
                });

                doc.save(`Relatorio-Servicos-${new Date().toLocaleDateString('pt-BR')}.pdf`);
            };

            gerarRelatorioProdutosBtn.addEventListener('click', gerarPDFRelatorioProdutos);
            
            carregarDados();
        }
    </script>
</body>
</html>
