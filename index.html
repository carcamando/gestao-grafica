<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Gráfica Traços Ltda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SDKs do Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
        // --- CONFIGURAÇÃO DO FIREBASE ---
        // TODO: Adicione aqui a configuração do seu projeto Firebase
        // Você pode encontrar isso nas configurações do seu projeto no console do Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyBlcb66W1kyFts9yvwim3bLHq6ctstQOak",
  authDomain: "sistema-gestao-grafica.firebaseapp.com",
  projectId: "sistema-gestao-grafica",
  storageBucket: "sistema-gestao-grafica.firebasestorage.app",
  messagingSenderId: "896118171238",
  appId: "1:896118171238:web:90eb4dea6dfc7cb195efa7"
        };
      
        // Inicializa o Firebase e os serviços
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null; // ID do usuário será definido após o login

        // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
        // Esta função só roda depois que o usuário está autenticado
        function runApp() {
            // --- VARIÁVEIS GLOBAIS ---
            let clientes = [], produtos = [], orcamentos = [], currentItems = [];
            let orcamentoCounter = 1, servicoCounter = 1, activeClientId = null;

            // --- SELETORES DO DOM ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const formCliente = document.getElementById('form-cliente');
            const listaClientes = document.getElementById('lista-clientes');
            const formProduto = document.getElementById('form-produto');
            const listaProdutos = document.getElementById('lista-produtos');
            const formOrcamento = document.getElementById('form-orcamento');
            const listaOrcamentos = document.getElementById('lista-orcamentos');
            const selectOrcamentoCliente = document.getElementById('orcamento-cliente');
            const selectItemProduto = document.getElementById('item-produto');
            const addItemBtn = document.getElementById('add-item-btn');
            const currentItemsContainer = document.getElementById('current-orcamento-items-container');
            const currentTotalSpan = document.getElementById('current-orcamento-total');
            const servicosModal = document.getElementById('servicos-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalButton = document.getElementById('close-modal-button');
            const formServico = document.getElementById('form-servico');
            const listaServicosContainer = document.getElementById('lista-servicos-container');

            // --- PERSISTÊNCIA DE DADOS (Firestore) ---
            const docRef = doc(db, "usuarios", userId);

            const salvarDados = async () => {
                const dataToSave = {
                    clientes,
                    produtos,
                    orcamentos,
                    orcamentoCounter,
                    servicoCounter
                };
                try {
                    await setDoc(docRef, dataToSave);
                    console.log("Dados salvos na nuvem com sucesso!");
                } catch (e) {
                    console.error("Erro ao salvar dados: ", e);
                    alert("Não foi possível salvar os dados na nuvem. Verifique sua conexão ou a configuração do Firebase.");
                }
            };

            const carregarDados = async () => {
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        clientes = data.clientes || [];
                        produtos = data.produtos || [];
                        orcamentos = data.orcamentos || [];
                        orcamentoCounter = data.orcamentoCounter || 1;
                        servicoCounter = data.servicoCounter || 1;
                        console.log("Dados carregados da nuvem.");
                    } else {
                        console.log("Nenhum dado encontrado na nuvem. Começando do zero.");
                        // O documento será criado na primeira vez que salvarDados() for chamado.
                    }
                } catch (e) {
                    console.error("Erro ao carregar dados: ", e);
                    alert("Não foi possível carregar os dados da nuvem. O aplicativo pode não funcionar corretamente.");
                }
                renderizarTudo();
            };

            // --- RENDERIZAÇÃO E FORMATAÇÃO ---
            const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;
            const renderizarTudo = () => {
                renderizarClientes();
                renderizarProdutos();
                renderizarOrcamentos();
            };
            const atualizarSelects = () => {
                selectOrcamentoCliente.innerHTML = '<option value="" disabled selected>Selecione...</option>';
                clientes.forEach((c, i) => selectOrcamentoCliente.add(new Option(c.nome, i)));
                selectItemProduto.innerHTML = '<option value="" disabled selected>Selecione...</option>';
                produtos.forEach((p, i) => selectItemProduto.add(new Option(p.nome, i)));
            };

            const renderizarClientes = () => {
                listaClientes.innerHTML = clientes.length === 0 ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum cliente</td></tr>' : clientes.map(c => {
                    const endereco = [c.endereco, c.numero, c.cidade].filter(Boolean).join(', ');
                    return `<tr id="cliente-${c.id}" class="hover:bg-gray-50"><td class="px-6 py-4"><span class="data-view">${c.nome}</span><input type="text" value="${c.nome}" class="edit-view w-full rounded-md"></td><td class="px-6 py-4"><span class="data-view">${c.telefone}</span><input type="tel" value="${c.telefone}" class="edit-view w-full rounded-md"></td><td class="px-6 py-4"><span class="data-view">${endereco||'N/A'}</span><input type="email" value="${c.email||''}" class="edit-view w-full rounded-md" disabled></td><td class="px-6 py-4 text-sm font-medium"><div class="flex items-center space-x-2"><button data-id="${c.id}" class="manage-services-btn text-green-600 hover:text-green-900">Serviços</button><button data-id="${c.id}" class="edit-btn text-blue-600 hover:text-blue-900">Editar</button><button data-id="${c.id}" class="save-btn text-blue-600 hover:text-blue-900" style="display:none;">Salvar</button><button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-900">Deletar</button></div></td></tr>`
                }).join('');
                atualizarSelects();
            };

            const renderizarProdutos = () => {
                listaProdutos.innerHTML = produtos.length === 0 ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum produto</td></tr>' : produtos.map(p => `<tr class="hover:bg-gray-50"><td class="px-6 py-4">${p.nome}</td><td class="px-6 py-4">${p.descricao||'N/A'}</td><td class="px-6 py-4">${p.quantidade||'N/A'}</td><td class="px-6 py-4">${p.valor>0?formatCurrency(p.valor):'N/A'}</td></tr>`).join('');
                atualizarSelects();
            };
            
            const renderizarOrcamentos = () => {
                listaOrcamentos.innerHTML = orcamentos.length === 0 ? '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum orçamento</td></tr>' : orcamentos.map(orc => `<tr class="hover:bg-gray-50"><td class="px-6 py-4">${String(orc.id).padStart(4,'0')}</td><td class="px-6 py-4">${orc.cliente.nome}</td><td class="px-6 py-4">${orc.items.map(i=>i.nome).join(', ')}</td><td class="px-6 py-4">${formatCurrency(orc.total)}</td><td class="px-6 py-4">${orc.data}</td><td class="px-6 py-4"><button data-id="${orc.id}" class="pdf-orcamento-btn text-red-600 hover:text-red-900">PDF</button></td></tr>`).join('');
            };
            
            const renderizarCurrentItems = () => {
                currentItemsContainer.innerHTML = currentItems.length === 0 ? '<p class="text-center text-gray-500">Nenhum item adicionado.</p>' : `<table class="min-w-full text-sm"><tbody>${currentItems.map((item,index)=>`<tr><td class="p-1">${item.nome}</td><td class="p-1">${item.quantidade} un.</td><td class="p-1 text-right">${formatCurrency(item.valorTotal)}</td><td class="p-1 text-right"><button type="button" data-index="${index}" class="remove-item-btn text-red-500 font-bold">&times;</button></td></tr>`).join('')}</tbody></table>`;
                currentTotalSpan.textContent = formatCurrency(currentItems.reduce((acc, item) => acc + item.valorTotal, 0));
            };
            
            // --- LÓGICA GERAL ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabContents.forEach(content => content.style.display = 'none');
                    document.getElementById(button.dataset.target).style.display = 'block';
                });
            });

            formCliente.addEventListener('submit', e => {
                e.preventDefault();
                clientes.push({ 
                    id: Date.now(), 
                    nome: e.target.elements['cliente-nome'].value, 
                    telefone: e.target.elements['cliente-telefone'].value, 
                    email: e.target.elements['cliente-email'].value, 
                    endereco: e.target.elements['cliente-endereco'].value,
                    numero: e.target.elements['cliente-numero'].value,
                    cep: e.target.elements['cliente-cep'].value,
                    cidade: e.target.elements['cliente-cidade'].value,
                    uf: e.target.elements['cliente-uf'].value,
                    servicos: [] 
                });
                salvarDados();
                renderizarClientes();
                formCliente.reset();
            });

            formProduto.addEventListener('submit', e => {
                e.preventDefault();
                produtos.push({ nome: e.target.elements['produto-nome'].value, descricao: e.target.elements['produto-descricao'].value, quantidade: parseInt(e.target.elements['produto-quantidade'].value, 10) || 0, valor: parseFloat(e.target.elements['produto-valor'].value) || 0 });
                salvarDados();
                renderizarProdutos();
                formProduto.reset();
            });

            listaClientes.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = parseInt(btn.dataset.id);
                const row = document.getElementById(`cliente-${id}`);
                if (btn.classList.contains('edit-btn')) {
                    row.querySelectorAll('.data-view').forEach(el => el.style.display = 'none');
                    row.querySelectorAll('td:not(:nth-child(3)):not(:last-child) .edit-view').forEach(el => el.style.display = 'block');
                    btn.style.display = 'none';
                    row.querySelector('.save-btn').style.display = 'inline-block';
                } else if (btn.classList.contains('save-btn')) {
                    const cliente = clientes.find(c => c.id === id);
                    cliente.nome = row.querySelector('input[type="text"]').value;
                    cliente.telefone = row.querySelector('input[type="tel"]').value;
                    cliente.email = row.querySelector('input[type="email"]').value;
                    salvarDados();
                    renderizarClientes();
                } else if (btn.classList.contains('delete-btn')) {
                    if (confirm('Tem certeza?')) {
                        clientes = clientes.filter(c => c.id !== id);
                        orcamentos = orcamentos.filter(o => o.cliente.id !== id);
                        salvarDados();
                        renderizarClientes();
                        renderizarOrcamentos();
                    }
                } else if (btn.classList.contains('manage-services-btn')) {
                    activeClientId = id;
                    const cliente = clientes.find(c => c.id === id);
                    modalTitle.textContent = `Serviços de ${cliente.nome}`;
                    renderizarServicos(id);
                    servicosModal.classList.add('visible');
                }
            });

            selectItemProduto.addEventListener('change', e => {
                if (e.target.value === "") return;
                const p = produtos[e.target.value];
                if (p) {
                    document.getElementById('item-descricao').value = p.descricao || '';
                    document.getElementById('item-quantidade').value = p.quantidade || 1;
                    const valorUnitario = (p.valor && p.quantidade > 0) ? (p.valor / p.quantidade) : (p.valor || 0);
                    document.getElementById('item-valor-unitario').value = valorUnitario.toFixed(2);
                }
            });

            addItemBtn.addEventListener('click', () => {
                const pIndex = selectItemProduto.value;
                if (pIndex === "") { alert('Selecione um produto.'); return; }
                const produto = produtos[pIndex];
                const quantidade = parseInt(document.getElementById('item-quantidade').value, 10);
                const valorUnitario = parseFloat(document.getElementById('item-valor-unitario').value);
                
                if (!quantidade || isNaN(valorUnitario)) { alert('Preencha a quantidade e o valor corretamente.'); return; }
                
                currentItems.push({ 
                    nome: produto.nome, 
                    descricao: document.getElementById('item-descricao').value, 
                    quantidade: quantidade, 
                    valorUnitario: valorUnitario,
                    valorTotal: quantidade * valorUnitario
                });
                renderizarCurrentItems();
                document.getElementById('form-item-container').querySelectorAll('input, select').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                });
            });
            
            currentItemsContainer.addEventListener('click', e => {
                const btn = e.target.closest('.remove-item-btn');
                if(btn) { currentItems.splice(btn.dataset.index, 1); renderizarCurrentItems(); }
            });

            formOrcamento.addEventListener('submit', e => {
                e.preventDefault();
                const clienteIndex = selectOrcamentoCliente.value;
                if (clienteIndex === "" || currentItems.length === 0) { alert("Selecione um cliente e adicione itens."); return; }
                orcamentos.push({ id: orcamentoCounter++, cliente: clientes[clienteIndex], items: [...currentItems], total: currentItems.reduce((acc, item) => acc + item.valorTotal, 0), data: new Date().toLocaleDateString('pt-BR') });
                currentItems = [];
                renderizarOrcamentos();
                renderizarCurrentItems();
                salvarDados();
                formOrcamento.reset();
                atualizarSelects();
            });

            listaOrcamentos.addEventListener('click', e => {
                const btn = e.target.closest('.pdf-orcamento-btn');
                if (btn) {
                    const orcamento = orcamentos.find(o => o.id === parseInt(btn.dataset.id));
                    if (orcamento) gerarPDFOrcamento(orcamento);
                }
            });
            
            // --- LÓGICA DO MODAL ---
            closeModalButton.addEventListener('click', () => servicosModal.classList.remove('visible'));
            
            const renderizarServicos = (clienteId) => {
                const cliente = clientes.find(c => c.id === clienteId);
                const relatorioBtn = servicosModal.querySelector('#gerar-relatorio-servicos-btn');
                if (!cliente.servicos || cliente.servicos.length === 0) {
                    relatorioBtn.style.display = 'none';
                    listaServicosContainer.innerHTML = '<p class="text-center py-4 text-gray-500">Nenhum serviço cadastrado.</p>';
                } else {
                    relatorioBtn.style.display = 'inline-block';
                    listaServicosContainer.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="p-2 text-left text-xs font-medium uppercase">Serviço</th><th class="p-2 text-left text-xs font-medium uppercase">Data</th><th class="p-2 text-left text-xs font-medium uppercase">Qtd.</th><th class="p-2 text-left text-xs font-medium uppercase">Valor</th><th class="p-2 text-left text-xs font-medium uppercase">Anexo</th><th class="p-2 text-left text-xs font-medium uppercase">Ações</th></tr></thead><tbody>${cliente.servicos.map(s=>`<tr id="servico-${s.id}"><td class="p-2"><span class="data-view">${s.descricao}</span><input type="text" value="${s.descricao}" class="edit-view w-full rounded-md"></td><td class="p-2"><span class="data-view">${new Date(s.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</span><input type="date" value="${s.data}" class="edit-view w-full rounded-md"></td><td class="p-2"><span class="data-view">${s.quantidade}</span><input type="number" min="1" value="${s.quantidade}" class="edit-view w-full rounded-md"></td><td class="p-2"><span class="data-view">${formatCurrency(s.valor)}</span><input type="number" step="0.01" value="${s.valor}" class="edit-view w-full rounded-md"></td><td class="p-2">${s.anexo?`<a href="${s.anexo.dados}" download="${s.anexo.nome}" class="text-blue-600">Baixar</a>`:'N/A'}</td><td class="p-2"><div class="flex items-center space-x-2"><button data-servico-id="${s.id}" class="edit-servico-btn text-blue-600">Editar</button><button data-servico-id="${s.id}" class="save-servico-btn text-blue-600" style="display:none;">Salvar</button><button data-servico-id="${s.id}" class="delete-servico-btn text-red-600">Excluir</button></div></td></tr>`).join('')}</tbody></table>`;
                }
            };
            
            formServico.addEventListener('submit', async e => {
                e.preventDefault();
                if (!activeClientId) return;
                const cliente = clientes.find(c => c.id === activeClientId);
                const fileInput = document.getElementById('servico-anexo');
                let anexo = null;
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    // Atenção: Salvar arquivos grandes pode exceder o limite do Firestore.
                    // O ideal para produção seria usar o Firebase Storage.
                    anexo = { nome: file.name, dados: await new Promise(resolve => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.readAsDataURL(file); }) };
                }
                cliente.servicos.push({ id: servicoCounter++, descricao: document.getElementById('servico-descricao-input').value, data: document.getElementById('servico-data').value, quantidade: parseInt(document.getElementById('servico-quantidade').value, 10) || 1, valor: parseFloat(document.getElementById('servico-valor').value), anexo: anexo });
                salvarDados();
                renderizarServicos(activeClientId);
                formServico.reset();
            });

            servicosModal.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if(!btn) return;

                if (btn.id === 'gerar-relatorio-servicos-btn') {
                     const cliente = clientes.find(c => c.id === activeClientId);
                     if (cliente) gerarPDFRelatorioServicos(cliente);
                     return;
                }

                const servicoId = parseInt(btn.dataset.servicoId);
                if (!servicoId) return;

                const cliente = clientes.find(c => c.id === activeClientId);
                const row = document.getElementById(`servico-${servicoId}`);
                
                if (btn.classList.contains('edit-servico-btn')) {
                    row.querySelectorAll('.data-view').forEach(el => el.style.display = 'none');
                    row.querySelectorAll('.edit-view').forEach(el => el.style.display = 'block');
                    btn.style.display = 'none';
                    row.querySelector('.save-servico-btn').style.display = 'inline-block';
                } else if (btn.classList.contains('save-servico-btn')) {
                    const servico = cliente.servicos.find(s => s.id === servicoId);
                    servico.descricao = row.querySelector('input[type="text"]').value;
                    servico.data = row.querySelector('input[type="date"]').value;
                    servico.quantidade = parseInt(row.querySelectorAll('input[type="number"]')[0].value, 10);
                    servico.valor = parseFloat(row.querySelectorAll('input[type="number"]')[1].value);
                    salvarDados();
                    renderizarServicos(activeClientId);
                } else if (btn.classList.contains('delete-servico-btn')) {
                    if(confirm('Excluir este serviço?')){
                        cliente.servicos = cliente.servicos.filter(s => s.id !== servicoId);
                        salvarDados();
                        renderizarServicos(activeClientId);
                    }
                }
            });

            // --- GERADORES DE PDF ---
            const gerarPDFOrcamento = (orcamento) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const cliente = orcamento.cliente;
                let startY = 40;

                doc.setFontSize(18).text("Orçamento - Gráfica Traços Ltda", 14, 22);
                doc.setFontSize(11).text("Contato: (54) 99617-2271", 14, 30);
                doc.line(14, 32, 196, 32);
                doc.setFontSize(12);
                doc.text(`Data: ${orcamento.data}`, 196, startY, { align: 'right' });
                startY += 10;
                doc.text(`Cliente: ${cliente.nome}`, 14, startY);
                if (cliente.endereco) {
                    startY += 7;
                    doc.text(`Endereço: ${[cliente.endereco, cliente.numero, cliente.cidade, cliente.uf.toUpperCase()].filter(Boolean).join(', ')}`, 14, startY);
                }

                doc.autoTable({
                    head: [["Produto", "Descrição", "Qtd.", "Vlr. Unit.", "Vlr. Total"]],
                    body: orcamento.items.map(i => [i.nome, i.descricao, i.quantidade, formatCurrency(i.valorUnitario), formatCurrency(i.valorTotal)]),
                    startY: startY + 5, theme: 'striped', headStyles: { fillColor: [30, 64, 175] },
                    columnStyles: { 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right' } }
                });
                let finalY = doc.lastAutoTable.finalY;
                doc.setFontSize(14).setFont(undefined, 'bold').text('Total:', 148, finalY + 12, {align: 'right'});
                doc.text(formatCurrency(orcamento.total), 196, finalY + 12, {align: 'right'});
                doc.setFontSize(10).setFont(undefined, 'normal').text("Orçamento válido por 30 dias.", 14, finalY + 25);
                doc.save(`Orcamento-${cliente.nome}-${orcamento.data}.pdf`);
            };
            
            const gerarPDFRelatorioServicos = (cliente) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18).text(`Relatório de Serviços - ${cliente.nome}`, 14, 22);
                doc.setFontSize(11).text("Gráfica Traços Ltda", 14, 30);
                doc.line(14, 32, 196, 32);
                doc.setFontSize(12).text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, 196, 40, { align: 'right' });
                
                const tableColumn = ["Data", "Descrição", "Qtd.", "Valor Total"];
                const tableRows = cliente.servicos.map(s => [new Date(s.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'}), s.descricao, s.quantidade, formatCurrency(s.valor)]);
                
                doc.autoTable({
                    head: [tableColumn], body: tableRows, startY: 45, theme: 'grid',
                    headStyles: { fillColor: [30, 64, 175] },
                    columnStyles: { 0: { halign: 'center', cellWidth: 25 }, 2: { halign: 'center' }, 3: { halign: 'right' } }
                });

                doc.save(`Relatorio-Servicos-${cliente.nome}.pdf`);
            };
            
            // --- INICIALIZAÇÃO DA APLICAÇÃO APÓS AUTENTICAÇÃO ---
            carregarDados();
        }

        // --- AUTENTICAÇÃO FIREBASE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado (anonimamente)
                userId = user.uid;
                console.log("Usuário autenticado anonimamente:", userId);
                runApp(); // Roda a aplicação principal
            } else {
                // Usuário não está logado, tenta fazer login anônimo
                signInAnonymously(auth).catch((error) => {
                    console.error("Erro no login anônimo:", error);
                    alert("Não foi possível conectar ao serviço de autenticação. O aplicativo não funcionará offline.");
                });
            }
        });
    </script>
</body>
</html>
